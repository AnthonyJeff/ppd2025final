
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>GeoChat - RabbitMQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
    .box { background: white; padding: 20px; border-radius: 8px; max-width: 600px; margin: auto; }
    input, button, textarea { width: 100%; padding: 10px; margin: 5px 0; }
    textarea { height: 100px; }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>
<body>
  <div class="container mt-4">
    <div class="row">
      <div class="col-3 jumbotron">
        <!-- <h3>Contatos</h3> -->
        <!-- <div id="contact-list"></div> -->
        <div class="card" style="width: 18rem;">
          <div class="card-header">
            游닇Lista de Contatos
          </div>
          <ul class="list-group list-group-flush" id="contact-list">
            <!-- <li class="list-group-item">An item</li>
            <li class="list-group-item">A second item</li>
            <li class="list-group-item">A third item</li> -->
          </ul>
        </div>
      </div>

      <div class="col-9">
          

          <div class="card">
            <div class="card-header">
              游늸 GeoChat - RabbitMQ / RPC
            </div>
            <div class="card-body">
              <div class="box2">
                <div class="row">
                  <div class="col-6">
                      <div class="card" style="width: 18rem;">
                        <div class="card-header">
                          游닇Registro de Usu치rios
                        </div>
                        <div class="card-body">
                          <label>Usu치rio:</label>
                          <input class="form-control" type="text" id="username" placeholder="Seu nome" />
                          <label>Latitude:</label>
                          <input class="form-control" type="number" id="lat" placeholder="Latitude" step="any" />
                          <label>Longitude:</label>
                          <input class="form-control" type="number" id="lng" placeholder="Longitude" step="any" />
                          <button class="btn btn-primary" onclick="registerUser()">Registrar</button>
                        </div>
                      </div>
                  </div>

                  <div class="col-6">
                      <div class="card" style="width: 18rem;">
                        <div class="card-header">
                          游닇Enviar Mensagens
                        </div>
                        <div class="card-body">
                          <label>Enviar Para:</label>
                          <input type="text" id="to" placeholder="Nome do destinat치rio" />
                          <label>Mensagem:</label>
                          <input type="text" id="message" placeholder="Digite sua mensagem" />
                          <button onclick="sendMessage()">Enviar Mensagem</button>

                        </div>
                      </div>
                  </div>

                </div>

                <hr>

                

                <hr>

                <label>Ver Mensagens:</label>
                <button onclick="readMessages()">Ler Caixa de Entrada</button>
                <textarea id="inbox" readonly></textarea>
                </div>
            </div>
          </div>




          
      </div>
    </div>
  </div>


  <script>
    const API = "rpc.php";

    async function rpc(method, params = {}) {
      const res = await fetch(API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ jsonrpc: "2.0", method, params, id: Date.now() })
      });
      const data = await res.json();
      if (data.result !== undefined) return data.result;
      alert("Erro: " + data.error.message);
    }

    async function registerUser() {
      const name = document.getElementById("username").value;
      const lat = parseFloat(document.getElementById("lat").value);
      const lng = parseFloat(document.getElementById("lng").value);
      const result = await rpc("registerUser", { name, lat, lng });
      alert(result);
    }

    async function sendMessage() {
      const from = document.getElementById("username").value;
      const to = document.getElementById("to").value;
      const message = document.getElementById("message").value;
      const result = await rpc("sendToUser", { from, to, message });
      alert(result);
    }

    async function readMessages() {
      const user = document.getElementById("username").value;
      const messages = await rpc("readQueue", { user, consume: false });
      document.getElementById("inbox").value = messages.join("\n");
    }

    // async function atualizarContatos() {
    //   const contatos = await rpc("listContacts");

    //   const div = document.getElementById("contact-list");
    //   div.innerHTML = "";

    //   contatos.forEach(c => {
    //     const contato = document.createElement("div");
    //     contato.textContent = `${c.online ? "游릭" : "游댮"} ${c.name}`;
    //     div.appendChild(contato);
    //   });
    // }

    async function atualizarContatos() {
      const contatos = await rpc("listContacts");

      const ul = document.getElementById("contact-list");
      ul.innerHTML = "";

      contatos.forEach(c => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        //li.textContent = `${c.online ? "游릭" : "游댮"} ${c.name}`;
        li.innerHTML = `${c.online ? "游릭" : "游댮"} <strong>${c.name}</strong><br> 游깵 Lat: ${c.lat}, Long: ${c.lng}`;
        ul.appendChild(li);
      });
    }

    // chama ao carregar
    atualizarContatos();

    // atualiza a cada 5s
    setInterval(atualizarContatos, 5000);
  </script>
  <!-- <script src="client.js"></script> -->
</body>
</html>
